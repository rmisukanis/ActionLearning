<html>
<head>
  <title>OAuth2 Sample App - Intuit</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script>
    if(window.opener) {
      window.opener.location.href = '/connected'
      window.close()
    }

    function apiCall() {
      $("#result").html('Loading...')
      $.get("/api_call", function(data) {
        $("#result").html(JSON.stringify(data, null, 2))
      })
    }
    function revokeCall() {
      $("#result").html('Loading...')
      $.get("/api_call/revoke", function(data) {
        $("#result").html(JSON.stringify(data, null, 2))
      })
    }
    function refreshCall() {
      $("#result").html('Loading...')
      $.get("/api_call/refresh", function(data) {
        $("#result").html(JSON.stringify(data, null, 2))
      })
    }
    function queryPayment() {
      $("#result").html('Loading...');  // Show a loading message

      // Get the SQL query from the input field
      var sqlQuery = $("#sqlQueryPayment").val();  // Get value of input with id 'sqlQueryPayment'

      if (!sqlQuery) {
        $("#result").html("Please enter a valid SQL query.");
        return;
      }

      // Send the query to the backend
      $.get("/queryPayment", { query: sqlQuery }, function(data) {
        $("#result").html("");  // Clear loading message

        if (data.error) {
          $("#result").html('Error: ' + data.error);  // Handle any errors returned from the backend
          return;
        }

        // Render the payment summary as a table or JSON
        let html = "<h3>Payment Summary</h3><table border='1'><tr><th>Customer Name</th><th>Customer ID</th><th>Total Amount</th><th>Transaction Date</th><th>Payment ID</th></tr>";
        data.paymentSummary.forEach(payment => {
          html += `<tr>
            <td>${payment.CustomerName}</td>
            <td>${payment.CustomerId}</td>
            <td>${payment.TotalAmount}</td>
            <td>${payment.TransactionDate}</td>
            <td>${payment.PaymentId}</td>
          </tr>`;
        });
        html += "</table>";
        $("#result").html(html);  // Display the results
      });
    }
  </script>
</head>
<body>
  <a href="/">Home</a>
  <h3>Connected!</h3>
  <p>Welcome<% if (locals.givenName) { %>, <%= locals.givenName %><% } %>!</p>
  <p>Would you like to make a sample API call?</p>
  <div>
    <button onclick="apiCall()">QuickBooks API Call</button>
    <button onclick="refreshCall()">Refresh Token Call</button>
    <button onclick="revokeCall()">Revoke Token Call</button><br><br>
    
    <label for="sqlQueryPayment">Enter Payment SQL Query:</label>
    <input type="text" id="sqlQueryPayment" placeholder="Enter your Payment SQL query here">
    <button onclick="queryPayment()">Fetch Payments From QuickBooks</button>

    <br><br>
    <div><code id="result"></code></div>
</body>
</html>
